---
import { getCollection } from 'astro:content';
import Layout from '@layouts/Layout.astro';
import Breadcrumb from '@components/Breadcrumb.astro';
import { Icon } from 'astro-icon/components';
import { siteConfig } from '@config/site';
import { slugify } from '@utils/slugify';

// Get all blog posts
const posts = await getCollection('posts', ({ data }) => {
  return !data.draft && data.series; // Ensure series data exists
});

// Group posts by series name and count parts
const seriesMap = new Map<string, number>();
posts.forEach(post => {
  const seriesName = post.data.series![0]; // series is [name, position]
  if (seriesName) {
    seriesMap.set(seriesName, (seriesMap.get(seriesName) || 0) + 1);
  }
});

// Convert map to array and sort alphabetically by series name
const seriesList = Array.from(seriesMap.entries())
  .map(([name, count]) => ({
    name,
    count,
    slug: slugify(name) // Use existing slugify utility
  }))
  .sort((a, b) => a.name.localeCompare(b.name));

const breadcrumbs = [
  { name: 'Home', url: '/' },
  { name: 'Series', url: '/series' }
];
---

<Layout 
  title={`Article Series - ${siteConfig.title}`}
  description="Browse all article series on our blog"
>
  <div class="w-full py-8">
    <Breadcrumb links={breadcrumbs} />
    <header class="mb-10 mt-4">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-4">
        Article Series
      </h1>
      <p class="text-lg text-gray-700 dark:text-gray-300">
        Browse articles grouped by series
      </p>
    </header>
    
    {seriesList.length > 0 ? (
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {seriesList.map(({ name, count, slug }) => (
          <a 
            href={`/series/${slug}/`}
            class="flex items-center justify-between p-5 bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition-shadow border border-gray-200 dark:border-gray-700"
          >
            <div class="flex items-center">
              <Icon name="mdi:bookshelf" class="w-6 h-6 text-blue-600 dark:text-blue-400 mr-3" />
              <span class="font-medium text-gray-900 dark:text-white">
                {name}
              </span>
            </div>
            <span class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-xs font-medium px-2.5 py-0.5 rounded-full">
              {count} {count === 1 ? 'part' : 'parts'}
            </span>
          </a>
        ))}
      </div>
    ) : (
      <div class="text-center py-12">
        <Icon name="mdi:package-variant-closed" class="w-16 h-16 text-gray-400 dark:text-gray-500 mx-auto mb-4" />
        <p class="text-xl text-gray-600 dark:text-gray-400">No series available yet.</p>
        <p class="text-gray-500 dark:text-gray-300">Check back soon!</p>
      </div>
    )}
  </div>
</Layout>
